-- Stelle sicher, dass du in AdventureWorksLT arbeitest
USE AdventureWorksLT2022;
GO

-- 1) Eigenes Schema für die Übung
IF NOT EXISTS (SELECT 1 FROM sys.schemas WHERE name = 'Xmas')
    EXEC('CREATE SCHEMA Xmas');
GO

-- 2) Konfiguration für Weihnachtsrabatte (Fixwerte)
DROP TABLE IF EXISTS Xmas.DiscountConfig;
GO

CREATE TABLE Xmas.DiscountConfig
(
    ConfigID int IDENTITY(1,1) PRIMARY KEY,
    MinOrderValue money NOT NULL,        -- ab welchem Bestellwert ein Rabatt greift
    MinItems int NOT NULL,               -- ab wie vielen Positionen ein Rabatt greift
    BaseDiscount decimal(5,4) NOT NULL,  -- Grundrabatt (z.B. 0.0500 = 5%)
    MaxDiscount  decimal(5,4) NOT NULL   -- Deckelung
);

INSERT INTO Xmas.DiscountConfig (MinOrderValue, MinItems, BaseDiscount, MaxDiscount)
VALUES
(   0.00, 0, 0.0000, 0.2500); -- Default: max. 25% Rabatt
GO






--1--
DROP FUNCTION IF EXISTS Xmas.fn_IsXmasSeason;
GO

CREATE FUNCTION Xmas.fn_IsXmasSeason (@d DATE)
RETURNS BIT
AS
BEGIN
	RETURN CASE 
		WHEN MONTH(@d) = 12 AND DAY(@d) <= 24 THEN 1
	ELSE 0
END;
END;
GO

-- Test 1: 1. Dezember => Saison
SELECT Xmas.fn_IsXmasSeason('2019-12-01') AS Expected1;
-- Erwartet: 1

-- Test 2: 24. Dezember => Saison
SELECT Xmas.fn_IsXmasSeason('2019-12-24') AS Expected1;
-- Erwartet: 1

-- Test 3: 25. Dezember => keine Saison
SELECT Xmas.fn_IsXmasSeason('2019-12-25') AS Expected0;
-- Erwartet: 0

-- Test 4: 30. November => keine Saison
SELECT Xmas.fn_IsXmasSeason('2019-11-30') AS Expected0;
-- Erwartet: 0





--2--
DROP FUNCTION IF EXISTS Xmas.fn_OrderSummary;
GO

CREATE FUNCTION Xmas.fn_OrderSummary (@SalesOrderID INT)
RETURNS TABLE
AS
RETURN
(
    SELECT
        h.SalesOrderID,
        h.OrderDate,
        COUNT(d.SalesOrderDetailID) AS ItemCount,
        SUM(d.LineTotal) AS OrderValue,
        h.CustomerID
    FROM SalesLT.SalesOrderHeader h
    JOIN SalesLT.SalesOrderDetail d
        ON h.SalesOrderID = d.SalesOrderID
    WHERE h.SalesOrderID = @SalesOrderID
    GROUP BY
        h.SalesOrderID,
        h.OrderDate,
        h.CustomerID
);
GO


-- Suche dir eine existierende Bestellung
SELECT TOP 1 SalesOrderID FROM SalesLT.SalesOrderHeader ORDER BY SalesOrderID;
GO

-- Test: Summary muss 1 Zeile liefern und Werte plausibel sein
DECLARE @id int = (SELECT TOP 1 SalesOrderID FROM SalesLT.SalesOrderHeader ORDER BY SalesOrderID);

SELECT * 
FROM Xmas.fn_OrderSummary(@id);

-- Erwartung:
-- 1 Zeile mit SalesOrderID = @id
-- ItemCount > 0
-- OrderValue > 0
-- CustomerID nicht NULL
